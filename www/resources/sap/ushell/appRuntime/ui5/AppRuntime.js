// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/LoaderExtensions","sap/ushell/appRuntime/ui5/AppCommunicationMgr","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/ui/thirdparty/URI","sap/ushell/appRuntime/ui5/renderers/fiori2/RendererExtensions","sap/ushell/appRuntime/ui5/services/AppConfiguration","sap/ushell/appRuntime/ui5/services/ShellUIService","sap/ushell/appRuntime/ui5/services/UserStatus"],function(L,A,a,U,R,b,S,c){"use strict";var p=new U().search(true),C,s;var D="sap/ushell/appRuntime/ui5/AppRuntimeDefaultConfiguration.json";function d(){this.main=function(){var t=this;this.tempFixForCFuntilTheySubmitAFix();this.getPageConfig().then(function(){t.setModulePaths();A.init();Promise.all([t.initServicesContainer(),t.getAppInfo()]).then(function(v){var o=v[1];t.createApplication(t.getAppId(),o).then(function(r){t.renderApplication(r);});});});};this.tempFixForCFuntilTheySubmitAFix=function(){try{if(jQuery.sap.getUriParameters().get("sap-cf-fix-enabled")==="true"){jQuery("body").empty();jQuery("body").removeClass("sapUShellFullHeight");jQuery('body').attr('id','content');}}catch(e){jQuery.sap.log.error("tempFixForCFuntilTheySubmitAFix exception: "+e);}};this.getPageConfig=function(){var m,e;return new Promise(function(r){L.loadResource(D,{async:true}).then(function(g){m=jQuery.find("meta[name='sap.ushellConfig.ui5appruntime']")[0];e=JSON.parse(m.content);window['sap-ushell-config']=jQuery.extend(true,{},e,g);r();});});};this.setModulePaths=function(){if(window['sap-ushell-config'].modulePaths){var k=Object.keys(window['sap-ushell-config'].modulePaths);for(var e in k){jQuery.sap.registerResourcePath(k[e].replace(/\./g,'/'),window['sap-ushell-config'].modulePaths[k[e]]);}}};this.initServicesContainer=function(){return new Promise(function(r,e){sap.ui.require(["sap/ushell/appRuntime/ui5/services/Container"],function(o){o.bootstrap("local").then(function(){r();});});});};this.getAppId=function(){var e=p["sap-ui-app-id"];if(e===undefined){throw new Error("FATAL: missing URI parameter 'sap-ui-app-id'");}return e;};this.getAppInfo=function(){var o=window["sap-ushell-config"].ui5appruntime.config.appIndex.data,m=window["sap-ushell-config"].ui5appruntime.config.appIndex.module;return new Promise(function(r){if(o&&!jQuery.isEmptyObject(o)){r(o);}else{sap.ui.require([m.replace(/\./g,'/')],function(e){e.getAppInfo().then(function(g){r(g);});});}});};this.setApplicationParameters=function(o){var h=window.hasher.getHash(),H,e,i,P,g=new jQuery.Deferred();if(!h||!h.length>0){jQuery.sap.log.error("AppRuntime.validateParams - sHash = "+h);return g.resolve().promise();}function j(t){var E=sap.ushell.Container.getService("URLShortening").expandHash(t);e=sap.ushell.Container.getService("URLParsing").parseShellHash(E);e.appSpecificRoute=undefined;}function k(){H=sap.ushell.Container.getService("URLParsing").constructShellHash(e);i=H.indexOf("?");if(i>=0){P=H.slice(i+1);o.url+=(o.url.indexOf("?")<0)?"?":"&";o.url+=P;}}j(h);if(e&&e.params["sap-intent-param"]!=undefined){a.sendMessageToOuterShell("sap.ushell.services.NavTargetResolution.expandCompactHash",{"sHashFragment":h}).done(function(n){j(n);k();g.resolve();});}else{k();g.resolve();}return g.promise();};this.setHashChangedCallback=function(){function t(n,o){if(n&&typeof n==="string"&&n.length>0){a.sendMessageToOuterShell("sap.ushell.appRuntime.hashChange",{"newHash":n});}}window.hasher.changed.add(t.bind(this),this);};this.createApplication=function(e,o){var t=this;return new Promise(function(r,g){C=new sap.ui.core.ComponentContainer({id:"TODO-define-correct-ID-content",width:"100%",height:"100%"});sap.ushell.renderers.fiori2.utils.init();s=sap.ushell.Container.getService("ShellNavigation");s.init(function(){});s.registerNavigationFilter(function(n,h){if(sap.ushell.Container.getDirtyFlag()){return s.NavigationFilterStatus.Abandon;}return s.NavigationFilterStatus.Continue;}.bind(this));new S({scopeObject:C,scopeType:"component"});new c({scopeObject:C,scopeType:"component"});t.setApplicationParameters(o).done(function(){t.setHashChangedCallback();sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(u){u.createComponent({ui5ComponentName:e,applicationDependencies:o,url:o.url},"todo-replaceDummyShellHash",false).then(function(h){r(h);});});});});};this.renderApplication=function(r){C.setComponent(r.componentHandle.getInstance()).placeAt("content");};}var f=new d();f.main();return f;});
