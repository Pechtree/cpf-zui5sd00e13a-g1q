// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/applicationIntegration/AppLifeCycle','sap/ushell/ui/footerbar/ContactSupportButton','sap/ushell/ui/footerbar/EndUserFeedback','sap/ushell/EventHub','sap/ushell/Config'],function(r,U,A,C,E,a,b){"use strict";var _;function c(){if(!_){_=sap.ushell.Container.getRenderer("fiori2");}return _;}function d(){return c().getShellConfig();}function f(){return A.getElementsModel().getModel();}var g;return U.extend("sap.ushell.components.shell.MeArea.Component",{metadata:{version:"1.65.1",library:"sap.ushell.components.shell.MeArea",dependencies:{libs:["sap.m","sap.ui.layout"]}},createContent:function(){this._bSearchPrefsLoaded=false;this._bIsMeAreaCreated=false;g=b.last("/core/extension/enableHelp");var t=this,m;var e=function(s){this.toggleMeAreaView(m,s);}.bind(this);m=sap.ui.getCore().byId("meAreaHeaderButton");m.applySettings({tooltip:sap.ushell.Container.getUser().getFullName(),icon:'{/userImage/personPlaceHolder}',selected:{path:"/currentViewPortState",formatter:function(v){if(v==='LeftCenter'){return true;}return false;}},press:function(){e(!this.getSelected());},visible:true,enabled:true,showSeparator:false,ariaLabel:"{i18n>MeAreaToggleButtonAria}"}).removeStyleClass("sapUshellPlaceHolders");m.addEventDelegate({onAfterRendering:function(){m.$().attr("aria-pressed",m.getSelected());},onsapskipforward:function(o){sap.ushell.renderers.fiori2.AccessKeysHandler.bForwardNavigation=true;o.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsaptabprevious:function(o){var v=sap.ui.getCore().byId('viewPortContainer'),s=v.getCurrentState(),R;switch(s){case"LeftCenter":R=jQuery("#meAreaIconTabBar-content li:first");if(R.length>0){R[0].focus();}else{var h=b.last("/core/shell/enableRecentActivity");if(h&&f().getProperty("/enableTrackingActivity")){jQuery("#meAreaIconTabBar .sapMITBText")[0].focus();}else{o.preventDefault();jQuery('.sapUshellActionItem:last')[0].focus();}}break;case"Center":if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){o.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}break;default:}},onsapskipback:function(o){var v=sap.ui.getCore().byId('viewPortContainer'),s=v.getCurrentState(),n;switch(s){case"LeftCenter":o.preventDefault();n=jQuery("#meAreaIconTabBar .sapMITBSelected");if(n.length===0){n=jQuery(".sapUshellActionItem");}n[0].focus();break;case"Center":o.preventDefault();if(jQuery("#sapUshellFloatingContainerWrapper:visible").length==1&&(o.originalEvent.srcElement.id)!=""){sap.ui.getCore().getEventBus().publish("launchpad","shellFloatingContainerIsAccessible");}else if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}break;default:}}});A.getElementsModel().createTriggers([{fnRegister:function(){if(!t.oActionsDoable){t.oActionsDoable=b.on("/core/shell/model/currentState/actions").do(function(h){if(b.last("/core/shell/enableFiori3")){if(h&&h.length>0){c().showHeaderEndItem(["meAreaHeaderButton"],true);}else{c().hideHeaderEndItem(["meAreaHeaderButton"],true);}}else if(h&&h.length>0){c().showHeaderItem(["meAreaHeaderButton"],true);}else{c().hideHeaderItem(["meAreaHeaderButton"],true);}});}},fnUnRegister:function(){if(!t.oActionsDoable){t.oActionsDoable.off();t.oActionsDoable=null;}}}],false,["blank-home","blank"]);if(b.last("/core/shell/enableFiori3")){sap.ushell.Container.getRenderer("fiori2").oShellModel.addHeaderEndItem(["meAreaHeaderButton"],false,["home","app","minimal","standalone","embedded","embedded-home","lean"],true);}this._createMeArea();a.on('showMeArea').do(e);},_createMeArea:function(){if(this._bIsMeAreaCreated===true){return;}this._bIsMeAreaCreated=true;var m=sap.ui.view("meArea",{viewName:"sap.ushell.components.shell.MeArea.MeArea",type:'JS',viewData:c().getComponentData(),async:true});m.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"role",value:"region",writeToDom:true}));m.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:r.i18n.getText("MeAreaToggleButtonAria"),writeToDom:true}));this._createActionButtons();m.loaded().then(function(v){c().addLeftViewPort(m);});},toggleMeAreaView:function(m,s){if(!m||!m.getDomRef()){return;}if(m.getSelected()===!!s){return;}var e=f().getProperty('/currentState/stateName');var p={'embedded':true,'embedded-home':true,'standalone':true,'blank-home':true,'blank':true};this._createMeArea();if(p[e]===true){this._showActionsInPopOver(m);}else{this._switchToMeAreaView(m,s);}},_createActionButtons:function(){if(!sap.ui.getCore().byId("aboutBtn")){var o=new sap.ushell.ui.footerbar.AboutButton("aboutBtn");if(g){o.addStyleClass('help-id-aboutBtn');}c().addShellDanglingControl(o);}if(!sap.ui.getCore().byId("userSettingsBtn")&&!d().moveUserSettingsActionToShellHeader){var u=new sap.ushell.ui.launchpad.ActionItem("userSettingsBtn",{id:"userSettingsBtn",text:r.i18n.getText("userSettings"),icon:'sap-icon://action-settings'});if(g){u.addStyleClass('help-id-loginDetails');}c().addShellDanglingControl(u);}if(!d().moveContactSupportActionToShellHeader){b.on("/core/extension/SupportTicket").do(function(e){var h=sap.ui.getCore().byId("ContactSupportBtn");if(e&&!h){h=new C("ContactSupportBtn");c().addShellDanglingControl(h);if(g){h.addStyleClass('help-id-contactSupportBtn');}}if(h){h.setVisible(e);}});}f().setProperty('/showEndUserFeedback',false);function s(h,i){try{h.isEnabled().done(function(){f().setProperty('/showEndUserFeedback',true);var j=c().getEndUserFeedbackConfiguration();if(d().moveGiveFeedbackActionToShellHeader){jQuery.sap.measure.start("FLP:Shell.controller._createActionButtons","create give feedback as shell head end item","FLP");var t=sap.ui.getCore().byId("EndUserFeedbackHandlerBtn");t.setModel(f());t.setShowAnonymous(j.showAnonymous);t.setAnonymousByDefault(j.anonymousByDefault);t.setShowLegalAgreement(j.showLegalAgreement);t.setShowCustomUIContent(j.showCustomUIContent);t.setFeedbackDialogTitle(j.feedbackDialogTitle);t.setTextAreaPlaceholder(j.textAreaPlaceholder);t.setAggregation("customUIContent",j.customUIContent,false);i.attachPress(function(){t.firePress();});jQuery.sap.measure.end("FLP:Shell.controller._createActionButtons");}else if(!i){i=new E("EndUserFeedbackBtn",{showAnonymous:j.showAnonymous,anonymousByDefault:j.anonymousByDefault,showLegalAgreement:j.showLegalAgreement,showCustomUIContent:j.showCustomUIContent,feedbackDialogTitle:j.feedbackDialogTitle,textAreaPlaceholder:j.textAreaPlaceholder,customUIContent:j.customUIContent});if(g){i.addStyleClass('help-id-EndUserFeedbackBtn');}c().addShellDanglingControl(i);}i.setVisible(true);}).fail(function(){if(i){i.setVisible(false);}});}catch(e){jQuery.sap.log.error("EndUserFeedback adapter is not found",e.message||e);}}b.on("/core/extension/EndUserFeedback").do(function(e){var h=sap.ui.getCore().byId("EndUserFeedbackBtn");if(e){sap.ushell.Container.getServiceAsync("EndUserFeedback").then(function(i){s(i,h);});}else if(h){f().setProperty('/showEndUserFeedback',false);h.setVisible(false);}});},_showActionsInPopOver:function(o){var e=f().getProperty('/currentState/actions');if(!this.oActionsPopover){this.oActionsLayout=new sap.ui.layout.VerticalLayout();this.oActionsPopover=new sap.m.Popover("sapUshellActionsPopover",{showHeader:false,placement:sap.m.PlacementType.Bottom,content:this.oActionsLayout}).addStyleClass("sapUshellPopupContainer");}this.oActionsLayout.removeAllContent();this._createActionButtons();e.forEach(function(s,i){var h=sap.ui.getCore().byId(s);if(h&&h.setActionType){this.oActionsLayout.addContent(h);h.setActionType('standard');h.addStyleClass('sapUshellStandardActionItem');}}.bind(this));this.oActionsPopover.setModel(f());this.oActionsPopover.openBy(o);},_switchToMeAreaView:function(o,s){c().switchViewPortStateByControl(o,s?"LeftCenter":"Center");c().toggleOverFlowActions();},_getSearchPrefs:function(){function i(){try{return b.last("/core/shellHeader/headEndItems").indexOf("sf")!=-1;}catch(e){jQuery.sap.log.debug("Shell controller._createWaitForRendererCreatedPromise: search button is not visible.");return false;}}if(i()){sap.ui.require(['sap/ushell/renderers/fiori2/search/userpref/SearchPrefs','sap/ushell/renderers/fiori2/search/SearchShellHelperAndModuleLoader'],function(S){this._bSearchPrefsLoaded=true;var s=S.getEntry();s.isSearchPrefsActive().done(function(e){if(e){c().addUserProfilingEntry(s);}}.bind(this));}.bind(this));}},exit:function(){if(this.oActionsDoable){this.oActionsDoable.off();}}});});
