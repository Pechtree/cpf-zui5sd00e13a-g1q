// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/core/theming/Parameters','sap/ushell/library','sap/ui/Device','sap/ui/core/IconPool','./ShellTitle','sap/ushell/Config','sap/ushell/renderers/fiori2/AccessKeysHandler','sap/ushell/resources','./ShellAppTitle','./ShellHeaderRenderer'],function(q,C,T,l,D,I,S,a,A,r){"use strict";var s=0,n=0;var L;var i;var b;var c;var d="sapUshellShellShowSearchOverlay";var M=3,e=1,f=0.5,g=9,h=3,j=3,k=12;var m=C.extend("sap.ushell.ui.shell.ShellHeader",{metadata:{properties:{logo:{type:"sap.ui.core.URI",defaultValue:""},showLogo:{type:"boolean",defaultValue:true},searchState:{type:"string",defaultValue:"COL"},ariaLabel:{type:"string",defaultValue:undefined},showSeparators:{type:"boolean",group:"Appearance",defaultValue:false,deprecated:true}},aggregations:{headItems:{type:"sap.ushell.ui.shell.ShellHeadItem",multiple:true},headEndItems:{type:"sap.ushell.ui.shell.ShellHeadItem",multiple:true},search:{type:"sap.ui.core.Control",multiple:false},user:{type:"sap.ushell.ui.shell.ShellHeadUserItem",multiple:false,deprecated:true},title:{type:"sap.ushell.ui.shell.ShellTitle",multiple:false},appTitle:{type:"sap.ushell.ui.shell.ShellAppTitle",multiple:false}},associations:{shellLayout:{type:"sap.ui.base.ManagedObject",multiple:false}},events:{searchSizeChanged:{}}}});m.prototype.setVisible=function(v){v=v===undefined?true:!!v;q(".sapUshellShellHead, .sapUshellShellHead > .sapUshellShellCntnt").css("display",v?"":"none");C.prototype.setVisible.call(this,v);};m.prototype.getShellLayoutControl=function(){return sap.ui.getCore().byId(this.getShellLayout());};m.prototype.createUIArea=function(o){var p=document.getElementById('shell-hdrcntnt')||document.getElementById('shell-hdr');if(p){return;}var t=o||'canvas';var u=document.getElementById(t);if(u){u.insertAdjacentHTML('beforebegin','<header id="shell-hdr" class="sapContrastPlus sapUshellShellHead">'+'</header>');if(!this.getVisible()){this.setVisible(false);}this.placeAt('shell-hdr');}};m.prototype.SearchState={COL:"COL",EXP:"EXP",EXP_S:"EXP_S"};m.prototype.init=function(){this._rtl=sap.ui.getCore().getConfiguration().getRTL();this._handleMediaChange=function(p){if(!this.getDomRef()){return;}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();return;}this._refresh();};D.media.attachHandler(this._handleMediaChange,this,D.media.RANGESETS.SAP_STANDARD);this._handleResizeChange=function(){if(!this.getDomRef()){return;}var u=this.getUser();if(this.getUser()){u._checkAndAdaptWidth(!this.$("hdr-search").hasClass("sapUshellShellHidden")&&!!this.getSearch());}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();return;}this._refresh();};D.resize.attachHandler(this._handleResizeChange,this);this.data("sap-ui-fastnavgroup","true",true);this.oTitle=null;};m.prototype.exit=function(){D.media.detachHandler(this._handleMediaChange,this,D.media.RANGESETS.SAP_STANDARD);D.resize.detachHandler(this._handleResizeChange,this);if(this.oTitle){this.oTitle.destroy();}var o=document.getElementById('shell-hdr');if(o){o.parentElement.removeChild(o);}};m.prototype.setAccessKeyHandler=function(o){this._accessKeyHandler=o;};m.prototype.attachAccessKeyHander=function(o){if(!o){return;}q("#sapUshellHeaderAccessibilityHelper").focusin(function(E){var v=sap.ui.getCore().byId('viewPortContainer'),p=v.getCurrentState(),t;if(o.bForwardNavigation){switch(p){case"Center":if(o.getAppKeysHandler()){setTimeout(function(){o.fnExternalKeysHandler(E,o.bFocusPassedToExternalHandlerFirstTime);o.bFocusPassedToExternalHandlerFirstTime=false;o.bFocusOnShell=false;},0);}else{var u=q(":focusable").filter("[tabindex!='-1']"),w=u.index(document.activeElement),t=u.eq(w+1);if(!t.length){var x=document.getElementById(v.getCurrentCenterPage());if(x.tagName==="IFRAME"){o.bForwardNavigation=false;x.focus();}else{t=u[0];}}}break;case"LeftCenter":t=q("#logoutBtn");if(t.length===0){t=q("#userStatusOpener");}break;case"RightCenter":t=q("#sapUshellNotificationIconTabByDate");o.bFocusOnShell=false;break;}}else{var H=this.getHeadEndItems(),y;if(H.length>0){y=H[H.length-1];t=y;}else t=this.getAppTitle();}setTimeout(function(){if(t){t.focus();}},0);}.bind(this));};m.prototype.onAfterRendering=function(){this._refresh();this.$("icon").one('load',this._refresh.bind(this));var o=this.$("hdr-search-container");if(s!=n){if(this.getSearchState()==this.SearchState.COL){o.one('transitionend',function(){q(this).addClass("sapUshellShellSearchHidden");});}this._setSearchContainerMaxSize(n,false);var p={remSize:this._convertPxToRem(this.getSearchContainerRect(n).width),isFullWidth:this.isPhoneState()};this.fireSearchSizeChanged(p);}else if(this.getSearchState()==this.SearchState.COL){q(o).addClass("sapUshellShellSearchHidden");}if(a.last("/core/extension/enableHelp")){q('#actionsBtn').addClass('help-id-actionsBtn');q('#configBtn').addClass('help-id-configBtn');q('#homeBtn').addClass('help-id-homeBtn');}this.attachAccessKeyHander(this._accessKeyHandler);};m.prototype.onThemeChanged=function(){this.invalidate();};m.prototype._getLogo=function(){return this.getLogo()||T._getThemeImage(null,true);};m.prototype._handleSearchSizeChanged=function(){var o;if(this.getSearchState()==this.SearchState.COL){return;}else if(this.getSearchState()==this.SearchState.EXP){o=s;this._handleExpSearchState(o);}else if(this.getSearchState()==this.SearchState.EXP_S){o=this._handleExpSSearchState();this._setSearchContainerMaxSize(o);}var p={remSize:this._convertPxToRem(this.getSearchContainerRect(o).width),isFullWidth:this.isPhoneState()};this.fireSearchSizeChanged(p);};m.prototype._refresh=function(){var u=this.getUser();if(u){u._refreshImage();u._checkAndAdaptWidth(!!this.getSearch());}if(!this.hasStyleClass("sapUshellShellHideLogo")){this._saveLogoWidth();}this._setMaxWidthForAppTitleAndTitle();if(this.getSearchState()!=this.SearchState.COL){this._adjustHeaderWithSearch();}this._saveSearchPhoneStateThreshold();};m.prototype._saveLogoWidth=function(){var o=this.$("hdr-begin").find(".sapUshellShellIco");if(o){i=parseInt(o.css("padding-left"),10);b=parseInt(o.css("padding-right"),10);L=this.$("icon")[0].getBoundingClientRect().width;}};m.prototype._convertPxToRem=function(p){var o=parseFloat(T.get("sapUiFontSize"));return p/o;};m.prototype._convertRemToPx=function(o){var p=parseFloat(T.get("sapUiFontSize"));return o*p;};m.prototype._setMaxWidthForAppTitleAndTitle=function(){this._setMaxWidthForAppTitle();if(this.isLSize()){this._setMaxWidthForTitle();}else{this._setAppTitleFontSize();}};m.prototype._setMaxWidthForAppTitle=function(){var o=this.$("hdr-appTitle");var p=this.$("hdr-appTitle").find(".sapUshellHeadTitle");if(!o.length){return;}p.removeClass('sapUshellHeadTitleWithSmallerFontSize');o.css({'max-width':'none'});var t=this._calcCenterWidth();var u=0;if(this.isLSize()){var v=this.$("hdr-title");if(v.length){u=v[0].getBoundingClientRect().width;}}var P=this.isSSize()?e:M;var w=this._convertPxToRem(t-u)-2*P;var x=o.find('.sapUshellShellHeadAction');var y=x.length?h+1.5:h;if(w<y){w=y;}o.css({'max-width':w+"rem"});};m.prototype._calcCenterWidth=function(){var o=this.$("hdr-appTitle")[0].getBoundingClientRect();var p=this.$("hdr-begin")[0].getBoundingClientRect();var t=this.$("hdr-end")[0].getBoundingClientRect();var u;if(this._isOverlapping(p,o)||this._isOverlapping(o,t)){var v=p.width;var w=t.width;var x=this.$()[0].getBoundingClientRect().width;u=x-2*Math.max(v,w);}else{var y=this.$("hdr-center");var u=y[0].getBoundingClientRect().width;}return u;};m.prototype._setMaxWidthForTitle=function(){var o=this.$("hdr-title");if(!o.length){return;}o.css({'max-width':k+"rem",'opacity':1});var p=this.$("hdr-appTitle");if(!p||!p[0]){return;}var R=this._isOverlapping(o[0].getBoundingClientRect(),p[0].getBoundingClientRect(),M,false);if(R){var t=o[0].getBoundingClientRect().width;var u=this._convertPxToRem(t-R);if(u<j){o.css({'opacity':0});}else{o.css({'max-width':u+"rem"});}}};m.prototype._setAppTitleFontSize=function(){var o=this.$("hdr-appTitle").find(".sapUshellHeadTitle");if(o&&o[0]){var p=o[0].scrollWidth;var t=o[0].clientWidth;if(p>t){o.addClass('sapUshellHeadTitleWithSmallerFontSize');}}};m.prototype._adjustHeaderWithSearch=function(o){var p=this.$("hdr-appTitle");if(!p.length||p.css('opacity')=="0"||p.css('display')=="none"){return;}var t=p[0].getBoundingClientRect();var u;if(o){u=this.getSearchContainerRect(o);}else{var v=this.$("hdr-search-container");u=this.getSearchContainerRect(parseFloat(v.get(0).style.maxWidth));}var O=this._isOverlapping(t,u,f,true);if(!O){return;}else if(O){var w=t.width;p.css({'max-width':this._convertPxToRem(w-O)+"rem"});}};m.prototype.setAppTitle=function(o){o.attachTextChanged(this._handleAppTitleChange,this);this.setAggregation("appTitle",o,true);};m.prototype.removeAppTitle=function(o){o.detachedTextChanged(this._handleAppTitleChange);this.removeAggregation("appTitle");};m.prototype._handleAppTitleChange=function(){if(!this.getDomRef()){return;}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();}};m.prototype.setTitleControl=function(t,o){this.oTitle=this.oTitle||sap.ui.getCore().byId("shellTitle");if(this.oTitle){this.oTitle.destroy();}this.oTitle=new S("shellTitle",{text:t,icon:I.getIconURI("overflow")});this.oTitle.setInnerControl(o);this.setTitle(this.oTitle);};m.prototype.removeHeadItem=function(v){if(typeof v==='number'){v=this.getHeadItems()[v];}this.removeAggregation('headItems',v);};m.prototype.addHeadItem=function(o){this.addAggregation('headItems',o);};m.prototype.isPhoneState=function(){var o=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;var E=true;var H=this.$().width();if(H<=c){E=false;}return(D.system.phone||o=="Phone"||!E);};m.prototype.isLSize=function(){var o=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;return(o=="Desktop");};m.prototype.isSSize=function(){var o=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;return(D.system.phone||o=="Phone");};m.prototype.getSearchContainerRect=function(o){var p=q("<div> </div>").css("max-width",o+"rem");var t=q("<div></div>").append(p).insertAfter(this.$("hdr-search-container"));p.addClass('sapUshellShellSearch');var u=p[0].getBoundingClientRect();t.remove();return u;};m.prototype.setSearchState=function(o,p,w){if(typeof o!=="string"||!this.SearchState.hasOwnProperty(o)){return;}this.requiredRemSize=p;this.setProperty('searchState',o,false);var t;if(o===this.SearchState.COL){t=this._handleColSearchState(true);}else if(o===this.SearchState.EXP){this.bWithOverlay=(w===false)?false:true;t=this._handleExpSearchState(p,true);}else if(o==this.SearchState.EXP_S){this.bWithOverlay=(w===true)?true:false;t=this._handleExpSSearchState(p,true);}this._setSearchContainerMaxSize(t,true);};m.prototype.getSearchAvailableSize=function(){var o=this._convertPxToRem(this._getSizeToAppTitle());var p=o-this._getMinPaddingRemSize();return(p>=0?p:0);};m.prototype._getSizeToAppTitle=function(){var o=this.$("hdr-center");var p=o[0];var t=this.$("hdr-appTitle").find(".sapUshellAppTitle");var u=t[0];var v;if(this._rtl){v=u?u.getBoundingClientRect().left-p.getBoundingClientRect().left:this._getSizeToTitle();}else{v=u?p.getBoundingClientRect().right-u.getBoundingClientRect().right:this._getSizeToTitle();}return v;};m.prototype._getSizeToTitle=function(){var o=this.$("hdr-center");var p=o[0];var t=this.$("hdr-title").find(".sapUshellHeadTitle");var u=t[0];var v;if(this._rtl){v=u?u.getBoundingClientRect().left-p.getBoundingClientRect().left:this._getSizeToLogo();}else{v=u?p.getBoundingClientRect().right-u.getBoundingClientRect().right:this._getSizeToLogo();}return v;};m.prototype._getSizeToLogo=function(){var o=this.$("hdr-center");var p=o[0];var t=p.getBoundingClientRect().width+this._getSearchButtonWidth();var u=this.$("hdr-begin").find(".sapUshellShellIco");var v=u[0];var w=false;if(this.hasStyleClass("sapUshellShellHideLogo")){w=true;}if(v&&w){var x=this._rtl?b:i;return t-L-x;}else{var x=this._rtl?i:b;return t+x;}};m.prototype._getMaxSize=function(){var o=this.$("hdr-center");var p=o[0];var t=this.$("hdr-begin").find(".sapUshellShellIco");var u=t[0];var v=false;if(this.hasStyleClass("sapUshellShellHideLogo")){v=true;}var w;if(u&&!v){var x=this._rtl?i:b;w=L+x;}else{w=0;}var y=p.getBoundingClientRect().width+this._getSearchButtonWidth()+w;return y;};m.prototype._getSearchButtonWidth=function(){var o=this.getHeadEndItems()[0];if(o&&o.getVisible()){var p=o.getDomRef();var t=p.getBoundingClientRect().width;return t;}return 0;};m.prototype._handleColSearchState=function(o){var p=this.getShellLayoutControl();if(p){p.removeStyleClass(d);}this.removeStyleClass(d);this.removeStyleClass("sapUshellShellHideLogo");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideAppTitle");if(this.isPhoneState()){return this._handleColSearchStatePhone();}return 0;};m.prototype._handleExpSearchState=function(o,p){var t=this.getShellLayoutControl();if(t){t.toggleStyleClass(d,this.bWithOverlay);}this.toggleStyleClass(d,this.bWithOverlay);if(this.isPhoneState()){this._handleExpAndExpSSearchStatePhone();return o;}else{return this._handleExpSearchStateLargeScreen(o,p);}};m.prototype._handleExpSearchStateLargeScreen=function(o,p){var t;this.removeStyleClass("sapUshellShellHideForPhone");var u=this._convertPxToRem(this._getMaxSize());var v=this._convertPxToRem(this._getSizeToTitle());var w=this._convertPxToRem(this._getSizeToAppTitle());var x=this._convertPxToRem(this._getSizeToLogo());if(o>u){this.addStyleClass("sapUshellShellHideLogo");this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");t=u;}else if(o>x-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideLogo");this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");t=o;}else if(o>v-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideLogo");t=o;}else if(o>w-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideLogo");t=o;}else{this.removeStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideLogo");t=o;}return t;};m.prototype._handleExpSSearchState=function(o,p){var t=this.getShellLayoutControl();if(t){t.toggleStyleClass(d,this.bWithOverlay);}this.toggleStyleClass(d,this.bWithOverlay);if(this.isPhoneState()){this._handleExpAndExpSSearchStatePhone();return o;}else{var u=this._handleExpSSearchStateLargeScreen(o,p);if(u>this.requiredRemSize){u=this.requiredRemSize;}return u;}};m.prototype._handleExpSSearchStateLargeScreen=function(o,p){var t;this.removeStyleClass("sapUshellShellHideForPhone");var u=this._convertPxToRem(this._getSizeToAppTitle());if(u-this._getMinPaddingRemSize()<g){u=g+this._getMinPaddingRemSize();}if(!o){o=u;}if(o>u-this._getMinPaddingRemSize()){t=u-this._getMinPaddingRemSize();}else{t=o;}this.removeStyleClass("sapUshellShellHideLogo");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideAppTitle");return t;};m.prototype._handleExpAndExpSSearchStatePhone=function(){this.addStyleClass("sapUshellShellHideForPhone");};m.prototype._handleColSearchStatePhone=function(){this.removeStyleClass("sapUshellShellHideForPhone");return 0;};m.prototype._setSearchContainerMaxSize=function(o,p){if(!p){var t=this.$("hdr-search-container");t.css("max-width",o+"rem");s=n=o;}else{n=o;}this._adjustHeaderWithSearch(o);};m.prototype._getMinPaddingRemSize=function(){if(this._convertPxToRem(this._getSizeToAppTitle())<g){return f;}else{return M;}};m.prototype._saveSearchPhoneStateThreshold=function(){if(this.hasStyleClass("sapUshellShellHideForPhone")){return;}var o=this.getSearchAvailableSize();if(o==0){o=-f;}var p=this._maxRemToRemoveFromAppTitle();if(o+p<g){var H=this.$().width();c=H+this._convertRemToPx(g-o-p);}return c;};m.prototype._maxRemToRemoveFromAppTitle=function(){var o=this.$("hdr-appTitle");var p=o.find(".sapUshellHeadTitle");if(!o.length||!p.length){return 0;}var t=this._convertPxToRem(p[0].getBoundingClientRect().width);var u=(t-h)>0?(t-h):0;return u;};m.prototype._isOverlapping=function(o,p,P,t){if(!P){P=0;}if(this._rtl){var u=o.left;var v=p.right;if(t){u=u-this._convertRemToPx(P);}else{v=v+this._convertRemToPx(P);}if(u<v){return v-u;}}else{var w=o.right;var x=p.left;if(t){w=w+this._convertRemToPx(P);}else{x=x-this._convertRemToPx(P);}if(x<w){if(o.bottom>p.top&&o.bottom<p.bottom){return w-x;}}}return 0;};m.prototype.getSearchMaxWidth=function(){return s;};return m;},true);
