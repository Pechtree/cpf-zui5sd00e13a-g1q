/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library","sap/base/Log"],function(q,U,N,F,a,b,J,R,A,c,B,d,P,T,C,V,t,e,f,L){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function h(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function j(k,l){var n={oAppComponent:k,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};n.oValidationMessageBinding.attachChange(q.noop);var p;var s;var u;function w(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");n.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:D.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});k.setModel(n.oTemplatePrivateGlobalModel,"_templPrivGlobal");n.oShellServicePromise.catch(function(){n.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function x(){n.fnAddSideEffectPromise=function(a1){var i=0;for(;n.aRunningSideEffectExecutions[i];){i++;}n.aRunningSideEffectExecutions[i]=a1;var b1=function(){n.aRunningSideEffectExecutions[i]=null;};a1.then(b1,b1);};p.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var a1=i.getParameter("promise");n.oBusyHelper.setBusy(a1);n.fnAddSideEffectPromise(a1);}});var $=k.getModel("_templPrivGlobal");var _="/generic/draftIndicatorState";p.attachBeforeQueueItemProcess(function(i){if(i.draftSave){$.setProperty(_,D.Saving);}});p.attachOnQueueCompleted(function(){if($.getProperty(_)===D.Saving){$.setProperty(_,D.Saved);}});p.attachOnQueueFailed(function(){if($.getProperty(_)===D.Saving){$.setProperty(_,D.Clear);}});$.setProperty("/generic/appComponentName",k.getMetadata().getComponentName());}function y(){var i={appComponent:k,oTemplateContract:n,application:new c(n),oViewDependencyHelper:new V(n)};n.oViewDependencyHelper=i.oViewDependencyHelper;n.oShellServicePromise=k.getService("ShellUIService").catch(function(){var _=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((_&&_.createInstance())||Promise.reject());});n.oShellServicePromise.catch(function(){L.warning("No ShellService available");});(U.prototype.init||q.noop).apply(k,arguments);n.oBusyHelper.setBusy(n.oShellServicePromise);u=r(i);var $=k.getModel();n.bCanonicalRequests=false;p=new A($);w();s=new d(n);x();C.enableAutomaticDraftSaving(n);if((!$.oMetadata||!$.oMetadata.isLoaded())||$.oMetadata.isFailed()){$.attachMetadataFailed(function(){s.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var _ in n.componentRegistry){n.componentRegistry[_].fnViewRegisteredResolve(true);}});}if(k&&k.getMetadata()&&k.getMetadata().getManifest()){e.setAppComponent(k);}e.setApplicationStatus(e.mApplicationStatus.LOADING);e.publishEvent("elements","ViewRenderingStarted",{});n.oBusyHelper.setBusyReason("initAppComponent",false);}function z(){if(n.oNavigationHost){return"";}if(n.sRoutingType==="f"){var i=new F();n.oNavigationHost=i;n.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];n.oNavigationObserver=new P({processObservers:n.aNavigationObservers});n.aHeaderLoadingObservers=[h(),h(),h()];}else{var $=new N({id:k.getId()+"-appContent"});n.oNavigationHost=$;n.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:$.attachNavigate.bind($),attachProcessStop:$.attachAfterNavigate.bind($)}});}n.oHeaderLoadingObserver=new P({processObservers:n.aHeaderLoadingObservers||[]});n.oPagesDataLoadedObserver=new P({processObservers:[n.oHeaderLoadingObserver,n.oNavigationObserver]});n.oNavigationHost.addStyleClass(n.oApplicationProxy.getContentDensityClass());n.oBusyHelper=new B(n);n.oBusyHelper.setBusyReason("initAppComponent",true,true);return n.oNavigationHost;}function E(){if(n.oNavigationHost){n.oNavigationHost.destroy();}if(p){p.destroy();}if(s){s.destroy();}if(n.oValidationMessageBinding){n.oValidationMessageBinding.destroy();}e.setAppComponent(null);(U.prototype.exit||q.noop).apply(k,arguments);u();t.endApp(l);}function G(i){var $=Object.keys(i).map(function(_){var a1=i[_];if(a1.pages){a1.pages=G(a1.pages);}return i[_];});return $;}function H($,_){if(!$){return;}for(var i=0;i<$.length;i++){var a1=$[i];if(a1.routingSpec&&a1.routingSpec.noOData){a1.entitySet=a1.routingSpec.routeName;if(_>1){a1.navigationProperty=a1.routingSpec.routeName;}}H(a1.pages,_+1);if(a1.embeddedComponents){for(var b1 in a1.embeddedComponents){var c1=a1.embeddedComponents[b1];if(c1.pages){c1.pages=G(c1.pages);H(c1.pages,_+1);}}}if(a1.implementingComponent&&a1.implementingComponent.pages){a1.implementingComponent.pages=G(a1.implementingComponent.pages);H(a1.implementingComponent.pages,_+1);}}}function I(i){if(i){var $=i.entitySet;var _=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var a1=function(_){for(var b1 in _){var c1=_[b1];if(!!c1.entitySet){return true;}}return false;};if(a1(_)){for(var b1 in _){var c1=_[b1];if(c1.entitySet===undefined){c1.entitySet=$;}}}}}var K;function M(){if(!K){var i=k.getMetadata();K=i.getManifestEntry("sap.ui.generic.app");if(K._version==="1.3.0"&&K.pages&&q.isPlainObject(K.pages)){K.pages=G(K.pages);}H(K.pages,0);I(K.pages[0]);}return K;}var O;function Q(){if(!O){O=q.extend({},k.getMetadata().getManifest());O["sap.ui.generic.app"]=M();}return O;}function S(){var i=k.getManifestObject();var $=i.getEntry("sap.ui.generic.app").settings;n.sRoutingType=($&&$.flexibleColumnLayout)?"f":"m";return"sap."+n.sRoutingType+".routing.Router";}var W=Promise.resolve();function X(){var i=new Promise(function($){W.then(function(){var _=[];n.oNavigationControllerProxy.getActiveComponents().forEach(function(a1){var b1=n.componentRegistry[a1];var c1=b1.oComponent.getComponentContainer();var d1=c1.getParent();if(d1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var e1=n.oNavigationControllerProxy.createComponentInstance(n,b1.routeConfig,n.oNavigationControllerProxy.mRouteToComponentResolve[b1.route]);_.push(e1.loaded().then(function(e1){var f1=c1.getComponentInstance().getBindingContext();d1.removePage(c1);d1.addPage(e1);d1.to(e1);c1.destroy();var g1=e1.getComponentInstance();var h1=n.componentRegistry[g1.sId];n.mRouteToTemplateComponentPromise[b1.route]=Promise.resolve(g1);if(f1){Promise.all([h1.viewRegistered,h1.reuseComponentsReady]).then(function(){h1.utils.bindComponent(f1.getPath(),true);});}return h1.oViewRenderedPromise;}));});$(Promise.all(_));});});W=i.then(q.noop);return W;}var Y={init:y,createContent:z,exit:E,_getRouterClassName:S,getConfig:M,getInternalManifest:Q,getTransactionController:function(){return p.getTransactionController();},getApplicationController:function(){return p;},getNavigationController:function(){return s;}};var Z={retemplateActiveComponents:X};if(sap.ui.getCore().getConfiguration().getDesignMode()){q.extend(Y,Z);}return Y;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},"considerAnalyticalParameters":{"type":"boolean","defaultValue":"false"},"showDraftToggle":{"type":"boolean","defaultValue":false}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();q.extend(this,j(this,i));(U.prototype.constructor||q.noop).apply(this,arguments);}});});
