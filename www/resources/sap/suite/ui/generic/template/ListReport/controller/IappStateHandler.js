sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log"],function(q,B,C,N,S,U,L){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.extensionData",b="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var c="";for(var k in D){s=s+c+k+": "+D[k];c="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,c,t){var o=t.oCommonUtils.getNavigationHandler();var e=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var h=false;var j=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var m;var p=null;var u=null;s.oSmartFilterbar.setSuppressSelection(true);var v=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function w(){return D;}function x(){var f1={};var g1=[];var h1=v();for(var i=0;i<h1.length;i++){var i1=h1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(i1)){g1.push(i1);}}var j1={suppressDataSelection:!D,visibleCustomFields:g1};f1[b]=j1;if(E){j1.editStateFilter=E.getSelectedKey();var k1=t.oComponentUtils.getTemplatePrivateModel();var l1=k1.getProperty("/listReport/activeObjectEnabled");j1.activeStateFilter=l1;}var m1=s.oMultipleViewsHandler.getContentForIappState();if(m1){var n1=m1.mode==="single"?"tableViewData":"tableTabData";j1[n1]=m1.state;}if(s.oWorklistData.bWorkListEnabled){var o1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var p1={"searchString":o1};j1.Worklist=p1;}var q1={};f1[d]=q1;c.getCustomAppStateDataExtension(q1);var r1;var s1=true;var t1=function(u1,v1){if(!(u1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!s1){throw new Error("State must always be provided synchronously");}if(v1){r1=r1||Object.create(null);var w1=u1.getMetadata().getNamespace();r1[w1]=v1;}};c.templateBaseExtension.provideExtensionAppStateData(t1);s1=false;if(r1){f1[a]=r1;}return f1;}function y(){var f1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var g1=new S(f1);var h1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<h1.length;i++){if(!g1.getValue(h1[i])){g1.addSelectOption(h1[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&g1.getID()){g1.setID("");}if(s.oWorklistData.bWorkListEnabled){var i1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";g1.addSelectOption("Worklist.SearchField","I","EQ",i1);}var j1={selectionVariant:g1.toJSONString(),tableVariantId:(!e&&s.oSmartTable.getCurrentVariantId())||"",customData:x()};return j1;}function z(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:k,bDataAreShownInTable:D});if(!k){return;}k=false;try{p=o.storeInnerAppStateWithImmediateReturn(y(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(p instanceof N){k=true;p=null;return;}p.promise.fail(function(f1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+f1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:p.appStateKey,sAppStateKeyInUrl:u});if(u===p.appStateKey){p=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:p.appStateKey});o.replaceHash(p.appStateKey);}}function R(f1,g1){var h1=t.oComponentUtils.getTemplatePrivateModel();if(f1&&f1.editStateFilter!==undefined){if(E){E.setSelectedKey((f1.editStateFilter===null)?0:f1.editStateFilter);h1.setProperty("/listReport/vDraftState",(f1.editStateFilter===null)?0:f1.editStateFilter);}h1.setProperty("/listReport/activeObjectEnabled",!!f1.activeStateFilter);if(s.oMultipleViewsHandler.getMode()==="multi"&&E){s.oMultipleViewsHandler.restoreActiveButtonState(f1);}}var i1=f1&&f1.visibleCustomFields;if(i1&&i1.length>0){var j1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<j1.length;i++){var k1=j1[i];var l1=k1.getName();if(i1.indexOf(l1)!==-1){k1.setVisibleInFilterBar(true);}}}D=g1&&!(f1&&f1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();b1(D);}}function F(i,e){if(e){var f1=i['sap-ui-fe-variant-id'];if(f1&&f1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(f1[0]);}}else{var g1=i['sap-ui-fe-variant-id'],h1=i['sap-ui-fe-filterbar-variant-id'],i1=i['sap-ui-fe-chart-variant-id'],j1=i['sap-ui-fe-table-variant-id'];G(h1&&h1[0],i1&&i1[0],j1&&j1[0],g1&&g1[0]);}}function G(i,f1,g1,h1){if(i||h1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||h1);}if(s.oSmartTable&&(g1||h1)){s.oSmartTable.attachAfterVariantInitialise(function(i1){s.oSmartTable.setCurrentVariantId(g1||h1);});s.oSmartTable.setCurrentVariantId(g1||h1);}if(s.oMultipleViewsHandler.getMode()==="multi"){s.oMultipleViewsHandler.setControlVariant(f1,g1,h1);}}function H(i){c.restoreCustomAppStateDataExtension(i||{});}function J(i){if(!i){return;}var f1=true;var g1=function(h1){if(!(h1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var i1=h1.getMetadata().getNamespace();if(!f1){throw new Error("State must always be restored synchronously");}return i[i1];};c.templateBaseExtension.restoreExtensionAppStateData(g1);f1=false;}function K(i,f1){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(b)){J(i[a]);H(i[d]);R(i[b],f1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}H(i);}s.oSmartFilterbar.fireFilterChange();}function M(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function O(i){var f1=t.oComponentUtils.getTemplatePrivateModel();f1.setProperty("/generic/bDataAreShownInTable",i);}function P(i,f1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:f1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:h,bAppStateDirty:k});O(f1);if(h){return;}if(i||f1!==D){D=f1;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(j){z();}else{setTimeout(z,0);}}}}}function Q(i){var f1=s.oSmartFilterbar.determineMandatoryFilterItems(),g1;for(var h1=0;h1<f1.length;h1++){if(f1[h1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){g1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(g1){i.oSelectionVariant.addParameter("P_DisplayCurrency",g1);}}break;}}}function T(i,f1,g1){l("fnAdaptToAppState called",{sNavType:g1,sAppStateKeyInUrl:u,sAppStateKey:i.appStateKey,storingInformationAppStateKey:p&&p.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=g1;var h1=i.appStateKey||"";if(h){return;}if(u===null){u=h1;}else if(h1!==u){return;}var i1=(!h1&&f1)||{};F(i1,e);h=true;var j1=i.selectionVariant||"";var k1=(!e&&i.tableVariantId)||"";var l1=i.oSelectionVariant||"";var m1={selectionVariant:l1,urlParameters:f1,selectedQuickVariantSelectionKey:""};var n1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var o1=n1.getSelectOption(d);var p1=n1.getSelectOption(b);if((r.appStateKey!==h1||r.selectionVariant!==j1||r.tableVariantId!==k1||f(r.urlParams,i1))&&g1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!p||p.appStateKey!==h1){var q1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){Q(i);}if(!s.oWorklistData.bWorkListEnabled){if(!q1||s.oSmartFilterbar.isCurrentVariantStandard()){m1.selectionVariant=i.oSelectionVariant;if(g1!==sap.ui.generic.app.navigation.service.NavType.iAppState){c.modifyStartupExtension(m1);e1(m1.selectionVariant,r,j1);c1(m1.selectionVariant.toJSONObject(),true,false);}else{e1(m1.selectionVariant,r,j1);c1(m1.selectionVariant.toJSONObject(),!q1,false);}}else{d1(n1,o1,p1,true);m1.selectionVariant=n1;c.modifyStartupExtension(m1);d1(m1.selectionVariant,o1,p1,false);if(!q.sap.equal(m1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){e1(m1.selectionVariant,r,j1);c1(m1.selectionVariant.toJSONObject(),true,false);}}}if(k1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(k1);}i.customData=i.customData||{};var r1=s.oMultipleViewsHandler.getMode();if(r1){var s1=r1==="single"?"tableViewData":"tableTabData";if(i.customData[b]&&i.customData[b][s1]){s.oMultipleViewsHandler.restoreFromIappState(i.customData[b][s1]);}}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[b]&&i.customData[b]["Worklist"]?i.customData[b]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}K(i.customData,true);}r={appStateKey:h1,urlParams:i1,selectionVariant:j1,tableVariantId:k1};}if(g1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(g1===sap.ui.generic.app.navigation.service.NavType.initial){d1(n1,o1,p1,true);m1.selectionVariant=n1;c.modifyStartupExtension(m1);d1(m1.selectionVariant,o1,p1,false);if(!q.sap.equal(m1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){e1(m1.selectionVariant,r,j1);c1(m1.selectionVariant.toJSONObject(),true,false);}}if(m1.selectedQuickVariantSelectionKey){var r1=s.oMultipleViewsHandler.getMode();if(r1){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var t1=c.getOwnerComponent().getModel("_templPriv");t1.setProperty("/listReport/multipleViews/selectedKey",m1.selectedQuickVariantSelectionKey);}}}}if(j){j();j=null;}if(g1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var u1=(g1===sap.ui.generic.app.navigation.service.NavType.xAppState||g1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;D=u1||s.bLoadListAndFirstEntryOnStartup||m||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();O(D);if(D){s.oSmartFilterbar.search();b1(D);}}if(g1==="initial"&&s.oWorklistData.bWorkListEnabled){if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}p=null;h=false;}function V(){if(!j){A=new Promise(function(f1){j=f1;});}var i=new Promise(function(f1,g1){var h1=o.parseNavigation();h1.done(function(i1,j1,k1){T(i1,j1,k1);f1();});h1.fail(function(i1,j1,k1){L.warning(i1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");T({},j1,sap.ui.generic.app.navigation.service.NavType.initial);f1();});});return i;}function W(){var i=y();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function X(){P(true,D);}function Y(i){var f1=i.getParameter("context");var g1=s.oSmartFilterbar.getFilterData();if(g1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var h1=g1._CUSTOM[b]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(h1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{K(g1._CUSTOM);}}else{var i1=x();n(i1[d]);n(i1[b]);K(i1);}if(I.indexOf(f1)<0){D=i.getParameter("executeOnSelect");P(true,D);}}function Z(){if(!e){P(true,D);}}function $(){if(!e){P(true,D);}}function _(i){var f1=i.getParameter("arguments");var g1=f1&&f1["?query"];u=(g1&&g1["sap-iapp-state"])||"";if(p){if(p.appStateKey!==u){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+u+" expected "+p.appStateKey);return false;}V();return true;}return false;}function a1(){m=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(z);}function b1(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}}function c1(i,f1,g1){var h1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(h1,{replace:f1,strictMode:g1});}function d1(i,f1,g1,h1){if(i&&(f1||g1)){if(h1){i.removeSelectOption(d);i.removeSelectOption(b);}else{i.massAddSelectOption(d,f1);i.massAddSelectOption(b,g1);}}}function e1(f1,r,g1){if(f1&&(r.selectionVariant!==g1||s.sNavType==="initial")){var h1=f1.getParameterNames().concat(f1.getSelectOptionsPropertyNames());for(var i=0;i<h1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(h1[i]);}}}s.getCurrentAppState=y;return{areDataShownInTable:w,parseUrlAndApplyAppState:V,getUrlParameterInfo:M,changeIappState:P,onSmartFilterBarInitialise:a1,onBeforeSFBVariantFetch:W,onAfterSFBVariantSave:X,onAfterSFBVariantLoad:Y,onAfterTableVariantSave:Z,onAfterApplyTableVariant:$,isStateChange:_};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,t){q.extend(this,g(s,c,t));}});});
